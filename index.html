<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RADIOHEAD | EUROPE 2025</title>
    <style>
        /* --- FONTS & BASE --- */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Syne+Mono&family=Xanh+Mono&display=swap');

        :root {
            --rh-black: #050505;
            --rh-white: #e0e0e0;
            --rh-red: #ff3300;
            --rh-acid: #ccff00;
            --rh-dim: #333;
            --rh-code-bg: rgba(0, 0, 0, 0.8);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--rh-black);
            font-family: 'Share Tech Mono', monospace;
            color: var(--rh-white);
            cursor: crosshair;
        }

        /* --- BACKGROUND --- */
        #bg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* background-image is set by JavaScript for random loading */
            background-size: cover;
            background-position: center;
            opacity: 0.4;
            filter: contrast(140%) grayscale(100%) brightness(0.6);
            z-index: 0;
        }
        
        #noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1;
            opacity: 0.12;
            background: url('data:image/svg+xml;utf8,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
        }

        /* --- TITLE --- */
        #main-title-img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70vw;
            max-width: 800px;
            mix-blend-mode: exclusion;
            pointer-events: none;
            z-index: 2;
            opacity: 0.7;
        }

        /* --- SVG LINES LAYER --- */
        #connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        path.connector {
            fill: none;
            stroke: var(--rh-white);
            stroke-width: 2; /* Increased thickness from 1 to 2 */
            stroke-dasharray: 2, 4; /* Dotted technical line */
            vector-effect: non-scaling-stroke;
            opacity: 0.6; /* Slight increase in opacity for visibility */
        }

        /* --- CITY NODES --- */
        .city-node {
            position: absolute;
            transform: translate(-50%, -50%);
            z-index: 50; 
            text-align: center;
            /* Allow clicking through the container to hit overlapping thumbnails if needed */
            pointer-events: none; 
        }

        /* The clickable text part */
        .city-label-group {
            position: relative;
            z-index: 200; /* ALWAYS ON TOP of thumbnails (rest state) */
            pointer-events: auto;
            display: inline-block;
            cursor: pointer; /* Change cursor to indicate clickability */
        }

        .city-name {
            font-family: 'Xanh Mono', monospace;
            font-size: 2.5rem;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--rh-white);
            background: var(--rh-black);
            padding: 4px 12px;
            border: 1px solid var(--rh-dim);
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            display: block; /* Make sure the name takes up the space */
        }

        .city-name:hover {
            background: var(--rh-white);
            color: var(--rh-black);
            border-color: var(--rh-white);
        }

        .city-date {
            font-family: 'Share Tech Mono', monospace;
            font-size: 1rem;
            color: var(--rh-acid);
            background: #000;
            padding: 2px 6px;
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            border: 1px solid var(--rh-acid);
            z-index: 201; /* Above city name */
            letter-spacing: 1px;
        }

        /* --- THUMBNAIL SPIRAL --- */
        .spiral-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            pointer-events: none;
            z-index: 100;
        }

        .thumb {
            position: absolute;
            /* Size is now set dynamically via JavaScript */
            background-color: #222;
            background-size: cover;
            background-position: center;
            border: 1px solid #444;
            pointer-events: auto;
            cursor: pointer;
            transition: all 0.15s ease-out;
            /* Filter removed to display thumbnails in color */
            opacity: 0.9; /* Slightly dimmed but in color */
            /* Center the anchor point for scaling */
            transform-origin: center center; 
        }

        /* Hover Interaction: The "Lens" Effect */
        .thumb:hover {
            width: 495px; /* Increased by 50% from 330px */
            height: 279px; /* Increased by 50% from 186px */
            z-index: 999 !important; /* Force to absolute top */
            filter: none; /* Ensure full color and brightness on hover */
            opacity: 1;
            border: 2px solid var(--rh-acid);
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            border-radius: 0;
        }

        /* Tooltip on hover */
        .thumb::after {
            content: attr(data-title);
            position: absolute;
            bottom: -20px;
            left: 0;
            background: var(--rh-acid);
            color: black;
            font-size: 10px;
            padding: 2px 4px;
            white-space: nowrap;
            display: none;
            font-weight: bold;
            box-shadow: 2px 2px 0 black;
        }
        .thumb:hover::after {
            display: block;
        }


        /* --- OVERLAY --- */
        #video-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(8px);
        }

        #video-container {
            width: min(95vw, 160vh); /* (16/9) * 90vh = 160vh */
            height: auto; 
            max-width: 1400px; /* Absolute pixel cap for massive monitors */
            aspect-ratio: 16/9;
            border: 1px solid var(--rh-white);
            box-shadow: 0 0 50px rgba(255,255,255,0.1);
            background: #000;
        }
        
        /* Ensure the placeholder wrapper fills the container */
        #player-placeholder {
            width: 100%;
            height: 100%;
        }

        iframe { width: 100%; height: 100%; border: none; }

        #close-btn {
            margin-top: 25px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            background: transparent;
            color: var(--rh-white);
            border: 1px solid var(--rh-white);
            padding: 10px 40px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }
        #close-btn:hover { background: var(--rh-white); color: black; }

        /* --- UI ELEMENTS --- */
        .glitch-footer {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 11px;
            color: #555;
            z-index: 5;
            max-width: 300px;
            line-height: 1.4;
        }

        /* --- ARCHIVAL CONSOLE --- */
        #analysis-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 250px;
            background: var(--rh-code-bg);
            border: 1px solid var(--rh-acid);
            padding: 15px;
            z-index: 1500;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 0 15px var(--rh-acid);
            display: none; /* Hidden by default */
        }
        #analysis-panel h3 {
            font-size: 1.1rem;
            color: var(--rh-acid);
            margin: 0 0 10px 0;
            text-transform: uppercase;
        }
        #analysis-panel p {
            margin: 0 0 10px 0;
        }
        .loading-text {
            color: #ffaa00;
        }
        .citation-link {
            font-size: 0.75rem;
            color: var(--rh-dim);
            text-decoration: none;
            display: block;
            margin-top: 5px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .citation-link:hover {
            color: var(--rh-acid);
        }


        /* Responsive */
        @media (max-width: 768px) {
            .city-name { font-size: 1.5rem; }
            /* Scaled hover size for mobile: 240px * 1.5 = 360px; 135px * 1.5 = 202.5px */
            .thumb:hover { width: 360px; height: 203px; } 
            
            #video-container {
                width: min(95vw, 142.22vh); 
                max-width: none; 
            }
            
            #analysis-panel {
                width: 90vw;
                right: 5vw;
                left: 5vw;
                max-height: 200px;
            }
        }

    </style>
</head>
<body>

    <div id="bg-layer"></div>
    <div id="noise"></div>
    <img id="main-title-img" src="https://radiohead.com/b1b.jpg" alt="Radiohead Art">

    <svg id="connections-layer">
        <path id="tour-path" class="connector" d="" />
    </svg>

    <div id="app-container"></div>

    <div class="glitch-footer">
        [SYSTEM_STATUS: ONLINE]<br>
        ARCHIVE_SIZE: (Curated Videos Only)<br>
        MODE: SPIRAL_DISTRIBUTION
    </div>

    <!-- New Archival Analysis Console -->
    <div id="analysis-panel">
        <h3>ARCHIVAL CONSOLE ✨</h3>
        <div id="analysis-content">
            Select a city label (e.g., 'Madrid') for historical concert context.
        </div>
    </div>

    <div id="video-overlay">
        <div id="video-container">
            <div id="player-placeholder"></div>
        </div>
        <button id="close-btn">DISCONNECT</button>
    </div>

    <script>
        // --- CONFIG & DATA (EASY TO CURATE) ---
        
        /**
         * CORE_TOUR_DATA is the main list you should edit.
         * Add your confirmed videos to the 'realVideos' array for each city.
         * The format is: { id: "YOUTUBE_ID", title: "Video Title" }
         * Only manually entered videos will be displayed, no filler content.
         */
        const CORE_TOUR_DATA = [
            {
                city: "Madrid", 
                dates: "NOV 04-08",
                realVideos: [
                    { id: "cmXDj-WeIqA", title: "RADIOHEAD — Full Show in Madrid 04/11/2025" }, 
                    { id: "ze8ZAlTyEIU", title: "Radiohead - FULL SHOW - live Madrid 2025-11-04 night 1 European Tour complete concert" }, 
                    { id: "-37QCDxOcak", title: "Radiohead Live Full Show Movistar Arena Madrid Spain November 5 2025 Night 2" }, 
                    { id: "fVqSV6seT-U", title: "Radiohead - Madrid 3rd night (FULL SHOW)" }, 
                    { id: "QzJs81sQ4Kg", title: "All I Need // 2025-11-05 Radiohead, Movistar Arena, Madrid // Strangeloving" }, 
                    { id: "7vJidz9ngfA", title: "Radiohead - Exit Music (For a Film) | Madrid Night 4" }, 
                    { id: "DOlcBb60AG0", title: "Idioteque // 2025-11-04 Radiohead, Movistar Arena, Madrid // Strangeloving" }, 
                    { id: "FqT9RPdN_rU", title: "RADIOHEAD 2025 First song live since 2018! Movistar Arena Madrid 04/11/2025" }, 
                    { id: "qCu7IAnpCLU", title: "Radiohead 11/5/25 “Planet Telex” at Movistar Arena in Madrid,Spain" }, 
                    { id: "XlUbeAy6LSE", title: "Radiohead - The Bends - live Madrid 2025-11-08 night 4" }, 
                    { id: "Hf8X6HDQM3E", title: "Radiohead - How To Disappear Completely | Madrid Movistar Arena | Nov 4, 2025 | Tour Opening Show" }, 
                    { id: "yhkaC_o-WAo", title: "Radiohead First show of 2025 tour @Movistar Arena, Madrid. First three Encores" }, 
                    { id: "CNrVXPYqHoE", title: "RADIOHEAD - there there @ MADRID 07/11/2025" },
                    { id: "6dBywGE_w-c", title: "Radiohead - Everything In Its Right Place (Live in Madrid, 04.11.2025)" },
                    { id: "X1EA7HAniQo", title: "Radiohead - EXIT MUSIC Live @ Madrid Night 2 | 05.11.2025" },
                    { id: "XvtOPJUxsk8", title: "Radiohead 11/4/25 “No Surprises” at Movistar Arena in Madrid,Spain" },
                    { id: "GPGWei_qcVk", title: "RADIOHEAD - weird fishes/arpeggi @ MADRID 07/11/2025" },
                    { id: "MX7FF0k-ScI", title: "Radiohead - Nude - live from Madrid 2025-11-05 night 2 European Tour" },
                    { id: "t896-xS5I58", title: "Radiohead Live at Movistar Arena Madrid – Concert Experience (Nov 2025)" },
                    { id: "6Gj46CRVE8o", title: "Radiohead - Paranoid Android @ Movistar Arena Madrid 4-NOV-2025 (4K)" },
                    { id: "6BQcG79LeNw", title: "Radiohead - Optimistic - live Madrid 2025-11-08 night 4" },
                    
                ]
            },
            {
                city: "Bologna", 
                dates: "NOV 14-18",
                realVideos: [
                    { id: "1kIPZKFqtdY", title: "Radiohead - Full Live (@ Bologna 15/11/2025)" },
                    { id: "uTMtoCLTcQA", title: "Radiohead Bologna 17th Nov 2025 full show HD" },
                    { id: "avNFiJIYuXs", title: "Radiohead full live Bologna 14 novembre 2025 multicam" },
                    { id: "KSP5jbAxMOs", title: "Radiohead Bologna 18th Nov 2025 full show in 4K" },
                    { id: "tY5o5rOfGzc", title: "Radiohead - Full Live (live in Bologna at Unipol arena 18/11/2025) 4K" },
                    { id: "Ap29YqzTAEw", title: "Radiohead concert Bologna 18 Nov 2025 - 10min taste of heaven!" },
                    { id: "17ezEAkou7k", title: "Paranoid Android - Radiohead // Bologna 15/11/2025 Unipol Arena" },
                    { id: "HQSOhfFLn94", title: "Radiohead - How to Disappear Completely, Live in Bologna 17/11/2025 Night 3" },
                    { id: "K2Pkih2bg9g", title: "Radiohead - Planet Telex (live in Bologna, 14.11.2025)" },
                    { id: "-ThAOXum6vY", title: "Radiohead - Jigsaw Falling Into Place, Live in Bologna 18/11/2025 Night 4" },
                    { id: "J3g_STgPzDw", title: "optimistic - radiohead bologna 2025" },
                    { id: "HoSiMYrXIsU", title: "Radiohead - Just, Live in Bologna 17/11/2025 Night 3" },
                    { id: "KTzc4eGE60g", title: "Radiohead / 2+2=5 - live a Bologna 14/11/2025" },
                    { id: "ps4tn0X_DAU", title: "RADIOHEAD On Fire! (Live Bologna 11-17-2025)" },
                ]
            },
            {
                city: "London", 
                dates: "NOV 21-25",
                realVideos: [
                    { id: "gKOJrbaVkVM", title: "Radiohead London o2 live full concert 4k" }, 
                    { id: "uISsWgTpHnw", title: "Paranoid Android - Radiohead - London" },
                    { id: "_KsR0NkBzAY", title: "Radiohead - Reckoner (Live) - The 02, London - 22-11-2025" },
                    { id: "5U2fq63173c", title: "Radiohead - All I Need (Live) - The 02, London - 22-11-2025" },
                    { id: "7E_c592nViw", title: "Radiohead - Jigsaw Falling Into Place (Live) - The 02, London - 22-11-2025" },
                    { id: "Skf72NYJXo0", title: "Just - Radiohead - o2 London - 21.11.2025" },
                    { id: "HweIP50pglA", title: "Radiohead - Planet Telex - London O2 Arena - 21st November 2025" },
                    { id: "IytYDbpA4-g", title: "Radiohead - Kid A - Live at The O2 Arena London 21/11/25" },
                    { id: "xNXqvlf34eY", title: "Radiohead - Paranoid Android - Live at The O2 Arena London 21/11/25" },
                    { id: "hYZTAJbQBlE", title: "RADIOHEAD - THE BENDS, LONDON O2, 22nd NOV 2025" },
                    { id: "0QAIK3eTkY0", title: "RADIOHEAD - 2+2=5, LONDON O2, 22nd NOV 2025" },
                    { id: "QOfKWSa4beo", title: "Radiohead- Street Spirit (O2 Arena London 22/11/2025" },
                    { id: "fcA2b-UIKs4", title: "RADIOHEAD - LET DOWN, LONDON O2, 22nd NOV 2025" },
                    { id: "wnBv1Z21sPE", title: "exit music - radiohead london 2025" },
                    { id: "xvBE5QSZTFk", title: "RADIOHEAD - EVERYTHING IN ITS RIGHT PLACE, LONDON O2, 22nd NOV 2025" },
                    { id: "lonpsppJLVo", title: "ful stop - radiohead london 2025" },
                    { id: "i5KZfNq7hoo", title: "Karma Police - Radiohead - O2 London - 21.11.2025" },
                    { id: "lonpsppJLVo", title: "ful stop - radiohead london 2025" },
                    { id: "i5KZfNq7hoo", title: "Karma Police - Radiohead - O2 London - 21.11.2025" },
                    { id: "OsNfe43zNYs", title: "Radiohead - No Surprises live @ O2 Arena, London 2025" },
                    { id: "q0DlPzq0J1g", title: "Paranoid Android - Radiohead - o2 London - 21.11.2025" },
                    { id: "Qdnc0U2KaoY", title: "RADIOHEAD - AIRBAG, LONDON O2, 22nd NOV 2025" },
                    { id: "DKV7DyF7gsA", title: "RADIOHEAD - NO SURPRISES, LONDON O2, 22nd NOV 2025" },
                    { id: "eE4lcd9cbHY", title: "Radiohead - Paranoid Android (Live) - The 02, London - 22-11-2025" },
                    { id: "ORYlcc9noIk", title: "Karma Police live. Radiohead O2 London" },
                    { id: "fGIwOxrpUdc", title: "RADIOHEAD - SIT DOWN. STAND UP, LONDON O2, 22nd NOV 2025" },
                    { id: "75CcgzKO9kg", title: "kid a - radiohead london 2025" },
                    { id: "xNXqvlf34eY", title: "Radiohead - Paranoid Android - Live at The O2 Arena London 21/11/25" },
                    { id: "hrrBpZiT4-g", title: "Radiohead - Let Down (Live) - The 02, London - 22-11-2025" },
                    { id: "jJoIti47xQE", title: "Radiohead - Optimistic (Live) - The 02, London - 22-11-2025" },
                    { id: "RO_xlKVHAbU", title: "Radiohead - Nude (Live) - The 02, London - 22-11-2025" },
                    { id: "Mq3Fwbk_-fQ", title: "No Surprises - Radiohead - O2 London - 21.11.2025" },
                    { id: "e_o7QuQiLZc", title: "No Surprises - Radiohead 21-nov-2025, O2 Arena London" },
                    { id: "k90aZQua9w0", title: "Radiohead - Let Down - London O2 Arena - 21st November 2025" },
                    { id: "G-Ld0N-5Nzw", title: "Radiohead - Separator (Live) - The 02, London -22-11-2025" },
                    { id: "8PdF7rIeJmA", title: "Radiohead - Weird Fishes/Arpeggi @ The O2 Arena, London, 21/11/2025" },
                    { id: "IojSFOMt6-w", title: "sit down stand up - radiohead london 2025" },
                    { id: "E3tJsfK3LLc", title: "Radiohead Perform Karma Police at London's O2 Arena" },
                    { id: "urjlpYrxSVM", title: "15 step - radiohead london 2025" },
                    { id: "HweIP50pglA", title: "Radiohead - Planet Telex - London O2 Arena - 21st November 2025" },
                    { id: "soP_8gsRvGo", title: "Let Down - Radiohead. Live at the o2 Arena, London. 21/11/25. ‪@Radiohead‬ ​" },
                    { id: "H_rWWC8grFk", title: "Kid A - Radiohead 21-nov-2025, O2 Arena London" },
                    { id: "Uis96pgKIzU", title: "Radiohead - Fake Plastic Trees - O2 Arena, London 21/11/2025 - Night 1" },
                    { id: "IytYDbpA4-g", title: "Radiohead - Kid A - Live at The O2 Arena London 21/11/25" },
                    { id: "XSVvK3lsGgc", title: "paranoid android - radiohead london 2025" },
                ]
            },
            {
                city: "Copenhagen", 
                dates: "DEC 01-05",
                realVideos: [
                ]
            },
            {
                city: "Berlin", 
                dates: "DEC 08-12",
                realVideos: [
                ]
            }
        ];

        // --- NEW BACKGROUND IMAGES ARRAY ---
        const BACKGROUND_IMAGES = [
            'https://rsrc.wasteheadquarters.com/ZDlkOTQ0MzVjMzAwODJlMjZhNzg0MzE3/6_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A2152.jpg',
            'https://rsrc.wasteheadquarters.com/YmFkM2U1YmNiZWQ0MWM2MzQ1ZDZkYmI2/7_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A2071.jpg',
            'https://rsrc.wasteheadquarters.com/MzUyYjk5OTU3NjA0ZDQxNzBhZGYxNTlk/8_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A1469.jpg',
            'https://rsrc.wasteheadquarters.com/ZGVmNzE5YWFiZmY5MTA2OWVhOWIwMzQw/1_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A1453.jpg',
            'https://rsrc.wasteheadquarters.com/Yzk3ODY1NDg5ODMzZDY0Y2FlNTYzYWEy/2_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A1696.jpg',
            'https://rsrc.wasteheadquarters.com/ODJhNjVkMWNjOGJmNWM4NzAwMzNmNjgw/4_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_IMG_9442.jpg',
            'https://rsrc.wasteheadquarters.com/ZGIzNzNjY2Q0MDhkYzU0ZDM1ZmY4NTM3/5_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A2569.jpg',
            'https://rsrc.wasteheadquarters.com/YWMzOGYwNmVjMWM3ZmU0MjM4MzQ2YjZl/9_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A2126.jpg',
            'https://rsrc.wasteheadquarters.com/YTc4MzJhYTIwZWViNmJmY2JhMjY0ZmZh/10_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A2258.jpg',
            'https://rsrc.wasteheadquarters.com/YjVhNzI1NDVkNmQ4NjUyNWRjYTE3NjI2/11_Bologna__RADIOHEAD_PHOTO_BY_ALEX_LAKE_TWOSHORTDAYS_9H0A1884.jpg'
        ];

        // --- LLM API INTEGRATION ---
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const analysisPanel = document.getElementById('analysis-panel');
        const analysisContent = document.getElementById('analysis-content');
        const appContainer = document.getElementById('app-container');
        const svgPath = document.getElementById('tour-path');


        /**
         * Robust fetch with exponential backoff for API calls.
         */
        async function backoffFetch(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) {
                        // Too Many Requests, wait and retry
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                }
            }
        }
        
        /**
         * Generates an archival note for a city using Gemini and Google Search grounding.
         * @param {string} city - The city name to search for.
         */
        async function generateArchivalNote(city) {
            analysisPanel.style.display = 'block';
            analysisContent.innerHTML = `<p class="loading-text">[SYSTEM_COMM] Fetching archival context for ${city}... Please wait.</p>`;

            const userQuery = `Find historical information about Radiohead playing live in ${city}, including notable setlist differences or unique performances. Summarize the findings in a single, short paragraph.`;
            
            const systemPrompt = "Act as a specialized music archivist and historian for the band Radiohead. Provide a concise, highly engaging, single-paragraph analysis focusing on the band's history and potential significance of the upcoming show in the specified location. Use a tone that is technical and reverent, reflecting the band's aesthetic. Do not use quotes. Use only facts from the search results.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await backoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sourcesHtml = '';
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        const sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title)
                            .slice(0, 3); // Limit to top 3 sources for display

                        if (sources.length > 0) {
                            sourcesHtml = '<h4>[DATA SOURCES]</h4>';
                            sources.forEach((source, index) => {
                                sourcesHtml += `<a href="${source.uri}" target="_blank" class="citation-link" title="${source.title}">[SRC ${index + 1}] ${source.title}</a>`;
                            });
                        }
                    }

                    analysisContent.innerHTML = `
                        <p>${text}</p>
                        ${sourcesHtml}
                    `;
                } else {
                    analysisContent.innerHTML = `<p class="loading-text">[SYSTEM_ERROR] Analysis failed. No content generated for ${city}.</p>`;
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                analysisContent.innerHTML = `<p class="loading-text">[SYSTEM_ERROR] Connection failure or API fault. Unable to retrieve archival data.</p>`;
            }
        }
        
        // --- LOGIC FUNCTIONS ---

        /**
         * Returns only the manually entered videos.
         */
        function generateVideos(realVideos) {
            return realVideos;
        }

        function randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1) + min); }
        
        /**
         * Selects a random image from the BACKGROUND_IMAGES array and applies it to the background layer.
         */
        function setRandomBackground() {
            const bgLayer = document.getElementById('bg-layer');
            const randomIndex = Math.floor(Math.random() * BACKGROUND_IMAGES.length);
            const selectedUrl = BACKGROUND_IMAGES[randomIndex];
            bgLayer.style.backgroundImage = `url('${selectedUrl}')`;
        }

        // Process CORE_TOUR_DATA (run once)
        const tourData = CORE_TOUR_DATA.map(data => ({
            ...data,
            videos: generateVideos(data.realVideos)
        }));

        // --- THUMBNAIL SIZE CONSTANTS ---
        const MIN_WIDTH = 75; 
        const MIN_HEIGHT = 45; 
        const MAX_WIDTH = 150; 
        const MAX_HEIGHT = 90; 
        const ASPECT_RATIO = MIN_WIDTH / MIN_HEIGHT; 

        // --- Spiral Scaling Base Constants ---
        // INCREASED these constants to ensure wider spread (from 65/16)
        const BASE_MIN_RADIUS = 100; // Starting distance from city center (pixels at 1.0 scale)
        const BASE_SPREAD = 25;     // Distance increase between thumbnails (pixels at 1.0 scale)
        const BASE_HEIGHT_PX = 900; // Baseline height for a scale factor of 1.0

        // --- LAYOUT ENGINE ---
        
        // Using "Zones" to keep cities somewhat apart
        const zones = [
            { x: [15, 25], y: [15, 25] }, // Top Left
            { x: [45, 55], y: [45, 55] }, // Center
            { x: [75, 85], y: [15, 25] }, // Top Right
            { x: [15, 25], y: [65, 75] }, // Bottom Left
            { x: [75, 85], y: [65, 75] }  // Bottom Right
        ];
        
        const cityPositions = tourData.map((data, index) => {
            const zone = zones[index % zones.length];
            return {
                ...data,
                x: randomInt(zone.x[0], zone.x[1]), 
                y: randomInt(zone.y[0], zone.y[1])
            };
        });

        // --- RENDER FUNCTION ---
        function renderTourNodes() {
            // 1. Clear the container before re-rendering
            appContainer.innerHTML = ''; 
            
            // 2. Calculate dynamic scale factor based on current window height
            // We use a slightly aggressive scale factor to force a wider spread
            const rawScale = window.innerHeight / BASE_HEIGHT_PX;
            const scaleFactor = Math.max(0.8, rawScale * 1.2); // Start higher and scale 20% faster
            
            // 3. Apply scale factor to base constants
            const spread = BASE_SPREAD * scaleFactor; 
            const minRadius = BASE_MIN_RADIUS * scaleFactor; 

            cityPositions.forEach((city, index) => {
                // A. Create City Container
                const node = document.createElement('div');
                node.className = 'city-node';
                node.style.left = `${city.x}%`;
                node.style.top = `${city.y}%`;
                
                // B. Add Label (Name + Date)
                const label = document.createElement('div');
                label.className = 'city-label-group';
                label.innerHTML = `
                    <div class="city-date">${city.dates}</div>
                    <div class="city-name">${city.city}</div>
                `;
                label.onclick = () => generateArchivalNote(city.city);

                node.appendChild(label);

                // C. Create Spiral Container
                const spiral = document.createElement('div');
                spiral.className = 'spiral-container';
                
                // D. GENERATE SPIRAL
                const goldenAngle = 137.508; 
                
                city.videos.forEach((video, vIndex) => {
                    const thumb = document.createElement('div');
                    thumb.className = 'thumb';

                    // --- RANDOM SIZE CALCULATION ---
                    const randomFactor = Math.random(); 
                    const randomWidth = MIN_WIDTH + (MAX_WIDTH - MIN_WIDTH) * randomFactor;
                    const randomHeight = randomWidth / ASPECT_RATIO;
                    
                    thumb.style.width = `${randomWidth}px`;
                    thumb.style.height = `${randomHeight}px`;
                    
                    // Spiral Math using scaled values
                    const angle = vIndex * goldenAngle * (Math.PI / 180);
                    const radius = minRadius + (spread * Math.sqrt(vIndex)); 
                    
                    const tx = Math.cos(angle) * radius;
                    const ty = Math.sin(angle) * radius;

                    thumb.style.transform = `translate(${tx}px, ${ty}px) rotate(${randomInt(-5, 5)}deg)`;
                    
                    // Data
                    thumb.setAttribute('data-title', video.title);
                    thumb.style.backgroundImage = `url('https://img.youtube.com/vi/${video.id}/hqdefault.jpg')`;

                    // Interaction
                    thumb.onclick = (e) => {
                        e.stopPropagation();
                        openOverlay(video.id);
                    };

                    spiral.appendChild(thumb);
                });

                node.appendChild(spiral);
                appContainer.appendChild(node);
            });
            
            // Ensure connectors are drawn after nodes are in the DOM
            drawLines();
        }


        // --- CONNECTORS ---
        function drawLines() {
            let pathD = "";
            const width = window.innerWidth;
            const height = window.innerHeight;

            cityPositions.forEach((city, i) => {
                const cx = (city.x / 100) * width;
                const cy = (city.y / 100) * height;

                if (i === 0) {
                    pathD += `M ${cx} ${cy} `;
                } else {
                    const prevX = (cityPositions[i-1].x / 100) * width;
                    const prevY = (cityPositions[i-1].y / 100) * height;
                    
                    // Jagged / Glitchy Line connection
                    pathD += `L ${prevX} ${prevY} L ${cx} ${cy} `;
                }
            });
            svgPath.setAttribute('d', pathD);
        }

        // --- OVERLAY LOGIC ---
        const overlay = document.getElementById('video-overlay');
        const playerContainer = document.getElementById('player-placeholder');
        
        function openOverlay(videoId) {
            overlay.style.display = 'flex';
            playerContainer.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&theme=dark&color=white" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
        }

        document.getElementById('close-btn').onclick = () => {
            overlay.style.display = 'none';
            playerContainer.innerHTML = '';
        };

        // --- INIT ---
        function initializeMap() {
            setRandomBackground();
            renderTourNodes(); 
            // Rerun rendering on resize to recalculate spread
            window.addEventListener('resize', renderTourNodes);
        }

        initializeMap();

    </script>
</body>
</html>
